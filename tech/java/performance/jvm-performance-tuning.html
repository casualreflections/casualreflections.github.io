<!DOCTYPE html>
<html>
<!--
====================================================
 ____  _   _ _   ___     ___    _   _
| __ )| | | | | | \ \   / / \  | \ | |
|  _ \| |_| | | | |\ \ / / _ \ |  \| |
| |_) |  _  | |_| | \ V / ___ \| |\  |
|____/|_| |_|\___/   \_/_/   \_\_| \_|

====================================================
Owner Name: Bhuvan Rawal
Profile: https://www.facebook.com/bhu1rawal
Version: 1.1
Description: Awesome dude, awesome life
====================================================
-->
<head>
<meta charset="utf-8">
<title>Performance tuning for java applications &#8211; Bhuvan Rawal</title>
<meta name="description" content="Understand java heap and how to tune it">
<meta name="keywords" content="Tech, Java, Performance, Debugging">

<!-- Twitter Cards -->
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="/images/omikron.png">
<meta name="twitter:title" content="Performance tuning for java applications">
<meta name="twitter:description" content="Understand java heap and how to tune it">
<meta name="twitter:creator" content="@beingbhuvan">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Performance tuning for java applications">
<meta property="og:description" content="Understand java heap and how to tune it">
<meta property="og:url" content="/tech/java/performance/jvm-performance-tuning">
<meta property="og:site_name" content="Bhuvan Rawal">
<meta property="og:image" content="/images/default_bg1.jpg">





<link rel="canonical" href="/tech/java/performance/jvm-performance-tuning">
<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Bhuvan Rawal Feed">
<link rel="author" href="https://plus.google.com/u/0/115368800868963120427?rel=author">
<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

    
    <link rel="stylesheet" type="text/css" href="/assets/css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/style.css" />

<div class="search-wrapper">
    <div class="search-form">
        <input type="text" class="search-field" placeholder="Search...">
        <i class="icon-remove-sign"></i>
        <ul class="search-results post-list"></ul><!-- /.search-results -->
    </div><!-- /.search-form -->
</div><!-- ./search-wrapper -->




<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144-precomposed.png">

</head>
<body class="post-template" itemscope itemtype="http://schema.org/WebPage">  
<div id="fade"></div>
<a id="slide" class="animated fade"></a>
<aside id="sidebar">
    <nav id="navigation">
    <h2>MENU</h2>
    <hr>

            <li>
                    <a href="/">Home</a>
                 </li>

            <li>
                    <a href="/categories">Categories</a>
                 </li>

            <li>
                    <a href="/tags">Tags</a>
                 </li>

            <li>
                    <a href="/about">Bhuvan who?</a>
                 </li>

            <li>
                    <a href="/contact">Contact me</a>
                 </li>

            <li>
                    <a href="/resume">Resume</a>
                 </li>
            
           <li><a href="/feed.xml" title="Atom/RSS feed"><i class="icon-rss"></i> Feed</a></li>
    </nav>
    
    
</aside>

<header id="masthead" class="blog-background overlay align-center align-middle animated from-bottom"  style="background-image: url(/images/default_bg1.jpg)" itemscope itemtype="http://schema.org/Organization">


    <button class="menu-button animated fade dosearch">
        <i class="icon-search"></i>
    </button>


    <div class="inner">
        <div class="container">
            <a class="brand" href="/" role="banner" itemprop="url">

                <img itemprop="logo" src="/images/omikron.png" alt="Bhuvan Rawal Logo" />

            <h1 class="blog-title light" itemprop="name">
                Bhuvan Rawal
            </h1>
                
            </a>
        </div>
    </div>
    
    
    <div class="decor-wrapper">
        <svg id="header-decor" class="decor bottom" xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 100 100" preserveAspectRatio="none">
            <path class="large left" d="M0 0 L50 50 L0 100" fill="rgba(255,255,255, .1)"></path>
            <path class="large right" d="M100 0 L50 50 L100 100" fill="rgba(255,255,255, .1)"></path>

            <path class="medium left" d="M0 100 L50 50 L0 33.3" fill="rgba(255,255,255, .3)"></path>
            <path class="medium right" d="M100 100 L50 50 L100 33.3" fill="rgba(255,255,255, .3)"></path>

            <path class="small left" d="M0 100 L50 50 L0 66.6" fill="rgba(255,255,255, .5)"></path>
            <path class="small right" d="M100 100 L50 50 L100 66.6" fill="rgba(255,255,255, .5)"></path>

            <path d="M0 99.9 L50 49.9 L100 99.9 L0 99.9" fill="rgba(255,255,255, 1)"></path>

            <path d="M48 52 L50 49 L52 52 L48 52" fill="rgba(255,255,255, 1)"></path>

        </svg>
    </div>
    
</header>
<div id="main" class="content" role="main" itemprop="mainContentOfPage" itemscope itemtype="http://schema.org/Blog">
    <div class="container">
        <div class="row">
            <article class="post col-md-8 col-md-offset-2 hentry" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">

            
            
            
                    <header class="post-header entry-header">
                    <div class="cursive">this post is featured</div>
                        
                        <h1 class="post-title text-center hyper lighter bordered-bottom entry-title" itemprop="headline">Performance tuning for java applications</h1>
                        
                        <div class="cursive" style="color: #000; font-style:italic;">Understand java heap and how to tune it</div>
                        <div class="post-info text-center small">
                            <span class="entry-date date published updated"><time datetime="2017-09-17T19:52:58+05:30" class="post-time" itemprop="datePublished">17 Sep 2017</time><span>
                            in <span class="post-tags"><a href="/categories/index.html#TechJavaPerformance" data-toggle="tooltip" title="Other posts from the Tech category" rel="tag">Tech</a>&nbsp;&bull;&nbsp;<a href="/categories/index.html#TechJavaPerformance" data-toggle="tooltip" title="Other posts from the Java category" rel="tag">Java</a>&nbsp;&bull;&nbsp;<a href="/categories/index.html#TechJavaPerformance" data-toggle="tooltip" title="Other posts from the Performance category" rel="tag">Performance</a></span>&nbsp;<span class="post-tags"><i class="icon-time"></i>&nbsp;<span class="time">12.635</span> minutes read</span>
                        </div>
                    </header>
                    <div class="post-body bordered-bottom" itemprop="description">
                        
                        <blockquote>
  <p>Special thanks to my colleague and friend Anshul, he has been indispensable in preparing this writeup.</p>
</blockquote>

<p>In this blog, we will try and understand the basics of jvm memory allocation and some jvm flags which should be put to use on production environments and sample programs to evaluate jvm strategy.</p>

<blockquote>
  <p>Heck !Why is understanding jvm important? My app seems to work fine.</p>
</blockquote>

<blockquote>
  <p>Did you know that 20% java applications suffer from pauses of more than 5 seconds, not understanding jvm pauses may inadvertently cause poor user experience. - <a href="https://plumbr.eu/blog/garbage-collection/revealing-the-length-of-garbage-collection-pauses">Plumbr.eu</a></p>
</blockquote>

<p>There is an ongoing debate about what made java special that it rose to popularity really quickly despite being invented approximately 20 years compared to its high level heavy weights competitors - C/C++.</p>

<p>One prominent reason for the distinct popularity and rise to fame of Java is the portability of application, i.e. compile once run everywhere. However one may ask this question - is portability really  important in todayâ€™s paradigm with prominent use cases of language belonging to server side on the cloud with homogeneous platforms? Probably not.</p>

<p>The other important advantage   java gives the developer is the near  complete independence from managing memory, while memory leaks are certainly possible but the possibility is reduced to a minimum, thereby reducing the time take in the development cycle.. No long running tests needed to check for that catastrophic missed free() call! And no explicit pointers mean avoidance of the dreaded segmentation fault!</p>

<p>The programmer declares memory on the heap and jvm assumes responsibility of liberate free memory in a background process called garbage collection. While it is certainly a gift and makes programming extremely less prone to issues, it can lead to performance troubles if not understood and tuned appropriately(after all gc is not controlled by the programmer), in this post we will try to understand how to tune a java application, understand the common jargons, avoid pitfalls and debug yourself out of one if you fall into it.</p>

<h2 id="basics-of-jvm-heap">Basics of JVM Heap:</h2>

<p>Unlike C/C++/Python jvm maintains a max heap size using a jvm parameter Xmx or MaxHeapSize,beyond which the application dies. If not specified it takes thedefault value which can be found for your machine using <code>java -XX:+PrintFlagsFinal -version</code>. The jvm param Xms specifies the starting size of the heap which the jvm requests from OS at the beginning.. As and when more memory is required, jvm requests memory if from OS till the Xmx limit is reached.</p>

<p>When the garbage collector runs it causes the application threads to pause. Although it cannot be avoided, the pause depends on the type of the collector employed (wheter it is serial/parallel, number of threads, compacting collector vs non compacting one or whether gc is operating on either young/old or complete memory is utilised and the dreaded <code>Full GC</code> is running).</p>

<p>There are several implementations of garbage collector algorithms - <strong>Serial Collector, Parallel GC, Parallel old gc, CMS, G1GC</strong>, etc. We will discuss the most common collection algorithm - Parallel compacting collector for YoungGen &amp; CMS for OldGen. G1GC is default garbage collector in java9 jigsaw with demonstrated performance improvement especially in larger heaps. Although it operates in a significantly different fashion than parallel collector / cms it shares same core DNA, heap is split into same segments although regions are further split into multiple regions. I will cover it in detail a seperate post.</p>

<p>The Java heap is broadly divided into 3 parts, namely <strong>young gen, old gen &amp; perm gen</strong>. Young gen comprises of <strong>Eden space</strong> where new objects are allocated and 2 survivor spaces one of which is always empty. GC runs on young gen (eden + 1 used survivor) which is also referred to as minor GC, the references which are old and are not in use are removed, the ones which are in use are transferred to remaining survivor space if it can fit in that space or promoted to old gen if either the age of objects has crossed the specified age limit or the size of used objects is more than the amount which can be fit in the empty survivor.</p>

<p>Its critical to understand why the algorithm is designed this way - in essence its to reduce the amount of space on which the GC algorithm operates on frequently. If we allow GC to run on full heap always and did not have a concept of old/yong gen we would have had long pauses leading to more unpredictable latencies and also there was a high probability of heap fragmentation - which is avoided by compacting collector. Majority of the times GC runs only on young gen allowing the application threads to run without large pauses.</p>

<h2 id="to-tune-your-baby-better---first-understand-it">To tune your baby better - first understand it</h2>

<p>One of the most common doubts people have while deploying server side java application is how much heap to allocate, what sould be the newGen/oldGen/survivorRatio, max pause times, etc.</p>

<p>While it is almost certain that there is no rule of thumb which can lead you to successful heap tuning(in kung fu panda terminology <code>There is no secret ingredient</code>), it is extremely critical to understand the kind of objects being allocated in order to determine the parameters. It is also important to have expectation of performance tuning activity either in terms of latency or throughput of application rarely ever can both be increased together.</p>

<p>For example - if improved latency is required, young gen size can be reduced. GC will run more frequently on young gen but application pauses will be short since the working set it will have to operate on will be less. This will invariably lead to shorter gc pauses on the young gen but since less time is given for objects to age before GC runs, there is higher chance of more objects getting transferred to tenured space.</p>

<p>The larger heap you allocate, better the throughput will be in general but it will result in longer GC pauses as the algorithm will invariably run over larger memory space.</p>

<p>There are broadly 3 kinds of GC events - One operating on Young Gen - Minor GC as we have seen, CMS or major GC which operates on old gen and 3rd kind <strong>Full GC</strong> which operates on entire heap both young and tenured spaces. Minor gc &amp; Major GC are forgiving as far as thread pauses are concerned with minor pauses lasting few milliseconds to no greater than 1 sec if things are working fine and parallelism is exploited well. The third GC event - dreaded <strong>Full GC</strong> runs when jvm has absolutely run out of heap in order to allocate more memory and it is not possible to go further without pausing complete application. Full GC runs on the entire heap and can pause a 10GB+ heap application for 15-30 seconds, even more.</p>

<p>So how much heap should be allocated and in what proportion?</p>

<p>A- Heuristically speaking, larger heap means improved throughput at the cost of increased higher percentile latencies. Smaller heap can allow low latency collections but since gc runs frequently and there is a high possibility of objects not being allowed to age on the young gen thereby increasing promotions. Therefore a judicious solution can be achieved via performance tests with throughput and latency numbers at close watch. It should be also taken into consideration that during performance testing the 3 different type of gc events are encountered so as to not encounter a new scenario on production. A large heap may not necessarily mean improved performance, infact it can lead to slow collections leading to jvm threads getting paused for longer spans.</p>

<h2 id="flags-to-use-on-production-environment">Flags to use on production environment</h2>

<p><code>-server</code></p>

<p>Usually -server flag is enabled by default esp on *nix platforms. It specifies that hotspot vm should tune the application as a long running server side application. The other option is -client, that enables quick startup and less aggressive JIT optimisations.</p>

<p><code>-Xms and -Xmx</code> (or: -XX:InitialHeapSize and -XX:MaxHeapSize)</p>

<p>-Xmx specifies maximum heap for young gen and old gen combined. Xms is the amount of heap jvm will request at the time of application startup.</p>

<p><code>-XX:+PrintGCTimeStamps -XX:+PrintGCDetails -Xloggc:[path to gc log file]</code>
<code>-XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=10 -XX:GCLogFileSize=100M</code></p>

<p>Use the above options to log GC details in a specified log with timestamp, 100MB max log file and 10 log files will be kept at max</p>

<p><code>-XX:+PrintGCApplicationStoppedTime -XX:+PrintGCApplicationConcurrentTime</code></p>

<p>This option will print the number of milliseconds application threads were stopped due to gc invocation.</p>

<p><code>XX:MaxTenuringThreshold</code></p>

<p>Determines number of gc cycles an object can go through before getting promoted to old gen.</p>

<p><code>-XX:+PrintTenuringDistribution</code></p>

<p>Prints the age distribution of objects after a gc is run. Output of this can be helpful in tuning survivor sizes, survivor ratio and MaxTenuringThreshold.</p>

<p><code>-XX:+HeapDumpOnOutOfMemoryError and -XX:HeapDumpPath</code></p>

<p>If in case the application goes out of memory and crashes, jvm will dump heap to a path specified in -Xx:HeapDumpPath, this can be useful in debugging which objects occupied large memory and could be leak suspects.</p>

<p><code>-XX:PermSize and -XX:MaxPermSize</code></p>

<p>While Xms and Xmx specify old and new gen heap sizes, we may want to specify and restrict PermGen size as well.</p>

<p><code>-XX:InitialCodeCacheSize and -XX:ReservedCodeCacheSize</code></p>

<p>Use these option to specify and restrict code cache, a memory area used by jvm for compilation and storage. This should rarely cause issues, but if it does it can potentially disable JIT compiler leading to glaring performance issues.</p>

<p><code>-XX:+DisableExplicitGC</code></p>

<p>This option will disable manual GC triggered anywhere in the application. Whenever we issue System.gc(), jvm can trigger a full gc leading to long STW pauses. One of the blogs illustrating problems faced with this flag disabled - <a href="http://java-n-stuff.blogspot.in/2009/08/turn-on-disableexplicitgc-now.html">link</a>.</p>

<p><code>-XX:+PerfDisableSharedMem</code></p>

<p>This will effectively disable tools like jstat, jps getting data out of your application, however this has seen improvements and has been discussed widely in community. More details on this <a href="http://www.evanjones.ca/jvm-mmap-pause.html">blog</a>.</p>

<p><code>CMSInitiatingOccupancyFraction=[%of oldgen] UseCMSInitiatingOccupancyOnly</code></p>

<p>CMSInitiatingOccupancyFraction will instruct the jvm to start CMS when specific percentage of oldgen is utilized, UseCMSInitiatingOccupancyOnly will disable gc heuristics and will kickin cms only when CMSInitiatingOccupancyFraction limit is reached.</p>

<h2 id="i-tried-hard-i-gave-my-best-tuning-strategy-but-my-app-ditched-me---that-dreaded-oom-error">I tried hard, I gave my best tuning strategy but my app ditched me - that dreaded OOM error</h2>

<p>From an ignorant perspective once an OOM strikes, the easiest way out would be to ignore it as an one off incident and restart the application. While that can solve the issue for that instant or probably some more but it cannot guarantee you sound sleep.</p>

<p>It is critical to enable heap dump on OOM error param of jvm in order to for the jvm to dump memory onto disk before killing itself and for you to have the ability to investigate what went wrong. For this two params need to be added <code>-XX:+HeapDumpOnOutOfMemoryError</code> and path of dump file generated <code>-XX:HeapDumpPath=[output heapdump path]</code></p>

<p>It is also important to have appropriate gc logging enabled which can give insight into the potential issues that could be present in application.</p>

<p>Websites such as <a href="http://gceasy.io/">gceasy</a> analyze log files and display in a graphical format and recommend potential issues with jvm heap.</p>

<h2 id="sample-programs-for-understanding-heap-analysis-tools">Sample programs for understanding heap analysis tools</h2>

<h3 id="sample-program-1">Sample Program-1</h3>
<p>Healthy application with only short lived objects</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">newHealthy</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Random</span> <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Random</span><span class="o">();</span>
        <span class="n">String</span><span class="o">[]</span> <span class="n">x</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">[</span><span class="mi">100</span><span class="o">];</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">x</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">nextDouble</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span></code></pre></figure>

<p><img src="https://image.ibb.co/kxtXR5/Screen_Shot_2017_09_18_at_1_14_26_AM.png" alt="" />
<img src="https://image.ibb.co/n7Jctk/Screen_Shot_2017_09_18_at_1_15_05_AM.png" alt="" /></p>

<p>It can be observed that very few objects are getting promoted to oldgen and almost all are collected by minor collections. In screenshot of jstat the OU column (Oldgen Utilised) is continuously showing 0, while Eden Utilised (EU) is filling up continuously.
This is evident from code as we are continuously inserting random string at same array index thereby freeing earlier references and making them eligible for garbage collection.</p>

<h3 id="sample-program-2">Sample Program-2</h3>

<figure class="highlight"><pre><code class="language-java" data-lang="java">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">oldHealthy</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Map</span> <span class="n">map</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">getProperties</span><span class="o">();</span>
        <span class="n">Random</span> <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Random</span><span class="o">();</span>
        <span class="n">String</span><span class="o">[]</span> <span class="n">x</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">[</span><span class="mi">100</span><span class="o">];</span>
        <span class="c1">// large initial hashmap to occupy some old heap</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">oldMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;(</span><span class="mi">10000000</span><span class="o">);</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">//map.put(r.nextInt(), &quot;value&quot;);</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">x</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">nextDouble</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span></code></pre></figure>

<p>This program is similar to sample-1 with the only difference being a hashmap with large memory being allocated which will be promoted to oldgen and occupy space there.</p>

<h3 id="sample-program-3">Sample program-3</h3>

<figure class="highlight"><pre><code class="language-java" data-lang="java">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">oldUnhealthy</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Random</span> <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Random</span><span class="o">();</span>
        <span class="n">String</span><span class="o">[]</span> <span class="n">x</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">[</span><span class="mi">100</span><span class="o">];</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Myclass</span><span class="o">&gt;</span> <span class="n">oldMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;(</span><span class="mi">1000000</span><span class="o">);</span>

        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">Myclass</span> <span class="n">myclass</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Myclass</span><span class="o">(</span><span class="s">&quot;ABC&quot;</span><span class="o">);</span>
                <span class="c1">//x[i] = String.valueOf(r.nextDouble());</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">50</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">//oldMap.put(String.valueOf(r.nextDouble()),</span>
                    <span class="c1">//    String.valueOf(r.nextDouble()));</span>
                    <span class="n">oldMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">nextDouble</span><span class="o">()),</span> <span class="n">myclass</span><span class="o">);</span>
                    <span class="n">LockSupport</span><span class="o">.</span><span class="na">parkNanos</span><span class="o">(</span><span class="mi">15000</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Myclass</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="n">String</span> <span class="n">myStr</span><span class="o">;</span>

        <span class="n">Myclass</span><span class="o">(</span><span class="n">String</span> <span class="n">myStr</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">myStr</span> <span class="o">=</span> <span class="n">myStr</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span></code></pre></figure>

<p>This program causes heap pressure on old gen leading to OOM error and jvm exiting. We are continuously inserting strong references into oldMap HashMap and memory is thus being leaked. The application tries to run for a while before falling into full gc trap eventually leading to OOM.</p>

<p><img src="https://preview.ibb.co/niN1m5/Screen_Shot_2017_09_18_at_1_26_25_AM.png" alt="" /></p>

<p>Once jvm is unable to recover memory it goes down with OOM as can be seen in logs below:</p>

<pre><code>    Exception in thread "main" java.lang.OutOfMemoryError: Java heap space
        at java.util.HashMap.newNode(HashMap.java:1742)
        at java.util.HashMap.putVal(HashMap.java:630)
        at java.util.HashMap.put(HashMap.java:611)
        at App.oldUnhealthy(App.java:147)
        at App.main(App.java:194)
</code></pre>

<p>Also heapdump file is created as we had enabled it in jvm params.</p>

<p>Heap dump file created [5748492 bytes in 2.021 secs]</p>

<h3 id="sample-program-4">Sample program-4</h3>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">class</span> <span class="nc">DeadlockSample</span> <span class="o">{</span>

    <span class="n">String</span> <span class="n">str1</span> <span class="o">=</span> <span class="s">&quot;str1&quot;</span><span class="o">;</span>
    <span class="n">String</span> <span class="n">str2</span> <span class="o">=</span> <span class="s">&quot;str2&quot;</span><span class="o">;</span>

    <span class="n">Thread</span> <span class="n">trd1</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="s">&quot;My Thread 1&quot;</span><span class="o">){</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(){</span>
            <span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">){</span>
                <span class="kd">synchronized</span><span class="o">(</span><span class="n">str1</span><span class="o">){</span>
                    <span class="c1">// Acquired lock on str1</span>
                    <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="n">l</span><span class="o">);</span>
                    <span class="kd">synchronized</span><span class="o">(</span><span class="n">str2</span><span class="o">){</span>
                        <span class="k">try</span><span class="o">{</span>

                            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Inside thread1, I wanna deadlock sleeping for 10000ms&quot;</span> <span class="o">+</span> <span class="n">str1</span> <span class="o">+</span> <span class="n">str2</span><span class="o">);</span>
                            <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">10000</span><span class="o">);</span>
                        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                        <span class="o">}</span>

                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">};</span>

    <span class="n">Thread</span> <span class="n">trd2</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="s">&quot;My Thread 2&quot;</span><span class="o">){</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(){</span>
            <span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">){</span>
                <span class="kd">synchronized</span><span class="o">(</span><span class="n">str2</span><span class="o">){</span>
                    <span class="c1">// Acquired lock on str2</span>
                    <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="n">l</span><span class="o">);</span>
                    <span class="kd">synchronized</span><span class="o">(</span><span class="n">str1</span><span class="o">){</span>
                        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                            <span class="k">try</span> <span class="o">{</span>
                                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span>
                                    <span class="s">&quot;Inside thread2, I wanna deadlock sleeping for 5000ms&quot;</span>
                                        <span class="o">+</span> <span class="n">str1</span>
                                        <span class="o">+</span> <span class="n">str2</span><span class="o">);</span>
                                <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">5000</span><span class="o">);</span>
                            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                            <span class="o">}</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">};</span>
<span class="o">}</span></code></pre></figure>

<p>This sample displays deadlock here we are creating two threads, both of which lock one object and are waiting for the other object locked by other thread, thereby they are locked forever.</p>

<p>When viewed in visualvm, it clearly detects that deadlock has happened, this can be observed in threaddump as well.</p>

<p><img src="https://image.ibb.co/c7EQDk/Screen_Shot_2017_09_18_at_1_31_47_AM.png" alt="" /></p>

<h3 id="sample-program-5">Sample program-5</h3>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">class</span> <span class="nc">ThreadAWaiting</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">testWaiting</span><span class="o">(){</span>
        <span class="n">ThreadBWaiting</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ThreadBWaiting</span><span class="o">();</span>
        <span class="n">b</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">&quot;Thread B&quot;</span><span class="o">);</span>
        <span class="n">b</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

        <span class="kd">synchronized</span><span class="o">(</span><span class="n">b</span><span class="o">){</span>
            <span class="k">try</span><span class="o">{</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Waiting for b to complete...&quot;</span><span class="o">);</span>
                <span class="n">b</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span>
            <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>

            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Total is: &quot;</span> <span class="o">+</span> <span class="n">b</span><span class="o">.</span><span class="na">total</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">ThreadBWaiting</span> <span class="kd">extends</span> <span class="n">Thread</span><span class="o">{</span>
    <span class="kt">int</span> <span class="n">total</span><span class="o">;</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(){</span>
        <span class="kd">synchronized</span><span class="o">(</span><span class="k">this</span><span class="o">){</span>
            <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">10000</span> <span class="o">;</span> <span class="n">i</span><span class="o">++){</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">notify</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>This sample displays an example of a thread taking lock on an object and other thread which is waiting for its completion, finally relinquishing control. This can be observed in screenshot below as well:</p>

<p><img src="https://image.ibb.co/fSAFDk/Screen_Shot_2017_09_18_at_1_33_33_AM.png" alt="" /></p>

<h2 id="references">References</h2>

<p><a href="https://docs.oracle.com/cd/E21764_01/web.1111/e13814/jvm_tuning.htm#PERFM150">1. Oracle JVM Tuning guide</a></p>

<p><a href="https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/">2. Oracle garbage collection tuning</a></p>

<p><a href="https://docs.oracle.com/cd/E13150_01/jrockit_jvm/jrockit/geninfo/diagnos/garbage_collect.html">3. Understanding memory management</a></p>

<p><a href="http://www.evanjones.ca/jvm-mmap-pause.html">4. Disable perf shared mem</a></p>

<p><a href="http://java-n-stuff.blogspot.in/2009/08/turn-on-disableexplicitgc-now.html">5. Turn on DisableExplicitGC now</a></p>

<p><a href="https://dzone.com/articles/best-kept-secret-jdk-visualvm">6. Best kept secret in jdk - jvisualvm</a></p>

<p><a href="https://www.javacodegeeks.com/2017/05/jvm-statistics-jstat.html">7. Jvm statistics with jstat</a></p>

<p><a href="https://meteatamel.wordpress.com/2012/03/21/deadlock-detection-in-java/">8. Deadlock detection with java</a></p>

<p>Here is a talk Anshul and me had given on JVM Tuning.
<script async="" class="speakerdeck-embed" data-id="9a9c6f11dea445d38498934a8183bd8e" data-ratio="1.33333333333333" src="//speakerdeck.com/assets/embed.js"></script></p>


                        <br>
                    
                    
                    <div class="entry-tags text-center">
                    
                        <i class="icon-tags"></i>&nbsp;Tagged with <a href="/tags/index.html#Tech" data-toggle="tooltip" title="Posts tagged with Tech" rel="tag">Tech</a>&nbsp;&bull;&nbsp;<a href="/tags/index.html#Java" data-toggle="tooltip" title="Posts tagged with Java" rel="tag">Java</a>&nbsp;&bull;&nbsp;<a href="/tags/index.html#Performance" data-toggle="tooltip" title="Posts tagged with Performance" rel="tag">Performance</a>&nbsp;&bull;&nbsp;<a href="/tags/index.html#Debugging" data-toggle="tooltip" title="Posts tagged with Debugging" rel="tag">Debugging</a>
                    
                    </div>
                    
                    </div>
        </div>
                    <footer class="post-footer entry-meta">
                        <div class="post-share text-center">
    <p class="light small">
        Share this post
    </p>
    <ul class="social-mini">
        <li>
            <a href="https://twitter.com/intent/tweet?text=&quot;Performance tuning for java applications&quot;%20/tech/java/performance/jvm-performance-tuning%20via%20&#64;beingbhuvan"
            onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" data-toggle="tooltip" title="Share on Twitter" itemprop="Twitter">
                <i class="icon-twitter"></i>
            </a>
        </li>
        <li>
            <a  href="https://www.facebook.com/sharer/sharer.php?u=/tech/java/performance/jvm-performance-tuning"
            onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;" data-toggle="tooltip" title="Share on Facebook" itemprop="Facebook">
                <i class="icon-facebook"></i>
            </a>
        </li>
        <li>
            <a href="https://plus.google.com/share?url=/tech/java/performance/jvm-performance-tuning"
           onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;" data-toggle="tooltip" title="Share on Google plus" itemprop="GooglePlus">
                <i class="icon-google-plus"></i>
            </a>
        </li>
    </ul>
</div>
                        <div class="post-author text-center">                       
	        <img src="/images/bhuvanrawal.jpg" alt="Bhuvan Rawal's photo" itemprop="image" class="post-avatar img-circle img-responsive"/>    
	    <h4 class="bordered-bottom vcard author" itemprop="author" itemscope itemtype="http://schema.org/Person">By <span itemprop="name" class="fn"><a href="/about" title="About Bhuvan Rawal" itemprop="url">Bhuvan Rawal</a></span></h4>
	    <p>Bhuvan Rawal is a Computer Science engineer based in New Delhi, India. His interests are anything that&#8217;s related to Technology and Science, from math to programming languages to music to physics to engineering to philosophy.</p>
</div> 
                        <div id="disqus_thread"></div><!-- /#disqus_thread -->
                    </footer>
            </article>
    </div>
</div>

<footer id="footer"  class="blog-background overlay text-center align-middle animated from-top" style="background-image: url(/images/default_bg1.jpg)" >


    <div class="inner">
        <div class="container">

            <ul class="social-icons">
            <li>
                <a href="http://twitter.com/beingbhuvan" data-toggle="tooltip" title="Bhuvan Rawal on Twitter" target="_blank">
                    <i class="icon-twitter"></i>
                </a>
            </li>
            <li>
                <a href="http://facebook.com/bhu1rawal" data-toggle="tooltip" title="Bhuvan Rawal on Facebook" target="_blank">
                    <i class="icon-facebook"></i>
                </a>
            </li>
            <li>
                <a href="https://plus.google.com/u/0/115368800868963120427" data-toggle="tooltip" title="Bhuvan Rawal on Google+" target="_blank">
                    <i class="icon-google-plus"></i>
                </a>
            </li>
            <li>
                <a href="https://stackexchange.com/users/4482379/bhuvan-rawal" data-toggle="tooltip" title="Bhuvan Rawal on StackExchange" target="_blank">
                    <i class="icon-stackexchange"></i>
                </a>
            </li>
            <li>
                <a href="https://in.linkedin.com/in/bhuvanrawal" data-toggle="tooltip" title="Bhuvan Rawal on LinkedIn" target="_blank">
                    <i class="icon-linkedin"></i>
                </a>
            </li>
            
            
            <li>
                <a href="http://github.com/bhuvanrawal" data-toggle="tooltip" title="Bhuvan Rawal on Github" target="_blank">
                    <i class="icon-github"></i>
                </a>
            </li>
        </ul>
            <div>
                <a href="/about/">Bhuvan Rawal</a> &copy; 2017 &bull; All rights reserved.
            </div>
            <ul class="menu-items">
            
            <li>
                
                    <a href="/"><i class="icon-home"></i></a>&nbsp;&bull;
                 
            </li>
            
            <li>
                
                    <a href="/categories">Categories</a>&nbsp;&bull;
                 
            </li>
            
            <li>
                
                    <a href="/tags">Tags</a>&nbsp;&bull;
                 
            </li>
            
            <li>
                
                    <a href="/about">Bhuvan who?</a>&nbsp;&bull;
                 
            </li>
            
            <li>
                
                    <a href="/contact">Contact me</a>&nbsp;&bull;
                 
            </li>
            
            <li>
                
                    <a href="/resume">Resume</a>&nbsp;&bull;
                 
            </li>
            
            <li><a href="/feed.xml" title="Atom/RSS feed"><i class="icon-rss"></i> Feed</a></li>
        </ul>
        </div>
    </div>
    
        <div class="decor-wrapper">
            <svg id="footer-decor" class="decor top" xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 100 100" preserveAspectRatio="none">

                <path class="large left" d="M0 0 L50 50 L0 100" fill="rgba(255,255,255, .1)"></path>
                <path class="large right" d="M100 0 L50 50 L100 100" fill="rgba(255,255,255, .1)"></path>

                <path class="medium left" d="M0 0 L50 50 L0 66.6" fill="rgba(255,255,255, .3)"></path>
                <path class="medium right" d="M100 0 L50 50 L100 66.6" fill="rgba(255,255,255, .3)"></path>

                <path class="small left" d="M0 0 L50 50 L0 33.3" fill="rgba(255,255,255, .5)"></path>
                <path class="small right" d="M100 0 L50 50 L100 33.3" fill="rgba(255,255,255, .5)"></path>

                <path d="M0 0 L50 50 L100 0 L0 0" fill="rgba(255,255,255, 1)"></path>

                <path d="M48 48 L50 51 L52 48 L48 48" fill="rgba(255,255,255, 1)"></path>

            </svg>
        </div>
    

</footer>

    
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="/assets/js/scripts.min.js"></script>
<script type="text/javascript" src="/assets/js/waypoints.min.js"></script>
<script type="text/javascript" src="/assets/js/script.js"></script>
<script type='text/javascript'>$(document).ready(function(){$(".time").text(function(a,b){return Math.round(parseFloat(b))})});</script>

<script type="text/javascript" src="/assets/js/custom.js"></script>

<script type="text/javascript">

/*      Slides       */

$("a#slide").click(function(){
    $("#sidebar,body,a#slide,#fade").addClass("slide")
});

$("#fade,#header,#posts-container").click(function(){
    $("#sidebar,body,a#slide,#fade").removeClass("slide")
});

$("a#click-filter").click(function(){
    $("#slide-filter").slideToggle("medium");
    $("#slide-pages").slideOut("medium");
});

$("a#click-pages").click(function(){
    $("#slide-pages").slideToggle("medium");
    $("#slide-filter").slideOut("medium");
});

/*      End-Slides      */

</script>


<!-- Jekyll Simple Search option -->
<script>
  $(document).ready(function() {
      $('.search-field').simpleJekyllSearch({
          jsonFile : '/search.json',
          searchResults : '.search-results',
          template : '<li><article><a href="{url}">{title} <span class="entry-date"><time datetime="{date}">{shortdate}</time></span></a></article></li>',
          noResults: '<p>Nothing found.</p>'
        });
  });

  (function( $, window, undefined ) {
    
     var bs = {
          close: $(".icon-remove-sign"),
          searchform: $(".search-form"),
          canvas: $("body"),
          dothis: $('.dosearch')
      };
    
    bs.dothis.on('click', function() {
      $('.search-wrapper').css({ display: "block" });
      bs.searchform.toggleClass('active');
      bs.searchform.find('input').focus();
      bs.canvas.toggleClass('search-overlay');
    });
    
      bs.close.on('click', function() {
        $('.search-wrapper').removeAttr( 'style' );
        bs.searchform.toggleClass('active');
        bs.canvas.removeClass('search-overlay');
    });
  })( jQuery, window );
</script>


<!-- Asynchronous Google Analytics snippet -->
<script>
  var _gaq = _gaq || [];
  var pluginUrl = 
 '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', 'UA-58286706-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'bhuvanrawal'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
 
</body>
</html>
